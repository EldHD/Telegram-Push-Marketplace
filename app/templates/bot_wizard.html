{% extends "base.html" %}

{% block content %}
<section class="wizard-header">
  <div>
    <h1>{% if bot %}Manage {{ bot.username }}{% else %}Add your bot{% endif %}</h1>
    <p class="muted">Complete all steps to activate your bot.</p>
  </div>
  <div class="wizard-progress">
    {% set can_navigate = bot and not bot.token_needs_update %}
    {% set steps = [
      {"id": 1, "label": "Connect"},
      {"id": 2, "label": "Audience"},
      {"id": 3, "label": "Verify"},
      {"id": 4, "label": "Pricing"},
      {"id": 5, "label": "Test"} if bot else None
    ] %}
    {% for step_item in steps if step_item %}
      {% if can_navigate %}
        <a class="step {% if step >= step_item.id %}active{% endif %}" href="/bot-owner/bots/{{ bot.id }}?step={{ step_item.id }}">
          {{ step_item.id }}. {{ step_item.label }}
        </a>
      {% else %}
        <div class="step {% if step >= step_item.id %}active{% endif %} {% if bot and step_item.id > 1 %}locked{% endif %}">
          {{ step_item.id }}. {{ step_item.label }}
        </div>
      {% endif %}
    {% endfor %}
  </div>
  {% if bot and bot.token_needs_update %}
    <div class="alert">
      Token has changed. Please update it to unlock the remaining steps.
    </div>
  {% endif %}
</section>

<div class="wizard" data-current-step="{{ step }}">
  <div class="wizard-step" data-step="1">
    <section class="card dark">
      <h2>Step 1 — Connect Bot</h2>
      {% if bot %}
        <form method="post" action="/bot-owner/bots/{{ bot.id }}/token" class="form-grid" data-token-form data-token-validation="{{ 'true' if bot.token_needs_update else 'false' }}">
          <input type="hidden" id="bot-username" value="{{ bot.username }}">
          <label>
            Bot username
            <input type="text" value="{{ bot.username }}" disabled>
            <small class="helper">Username cannot be edited after creation.</small>
          </label>
          <label>
            Bot token {% if bot.token_needs_update %}<span class="required">*</span>{% endif %}
            <input type="password" name="token" id="bot-token" placeholder="123456:ABC..." {% if not bot.token_needs_update %}disabled{% endif %} {% if bot.token_needs_update %}required{% endif %}>
            <small class="helper">Update the token if it was regenerated in BotFather.</small>
            <div class="validation-status" id="token-validation-status"></div>
            {% if errors and errors.get('token') %}
              <span class="error">{{ errors.get('token') }}</span>
            {% endif %}
          </label>
          <input type="hidden" name="token_validated" id="token-validated" value="false">
          <div class="form-actions">
            <button class="button secondary" type="button" id="validate-bot-token" {% if not bot.token_needs_update %}disabled{% endif %}>Validate token</button>
            <button class="button" type="submit" id="save-bot-button" {% if not bot.token_needs_update %}disabled{% endif %}>Update token</button>
          </div>
        </form>
      {% else %}
        <form method="post" action="/bot-owner/bots" class="form-grid" data-token-form data-token-validation="true">
          <label>
            Bot username <span class="required">*</span>
            <input type="text" name="username" id="bot-username" placeholder="@mycoolbot" required>
            <small class="helper">Use the bot username in Telegram. Must end with “bot”.</small>
            {% if errors and errors.get('username') %}
              <span class="error">{{ errors.get('username') }}</span>
            {% endif %}
          </label>
          <label>
            Bot token <span class="required">*</span>
            <input type="password" name="token" id="bot-token" placeholder="123456:ABC..." required>
            <small class="helper">We validate the token using Telegram getMe.</small>
            <div class="validation-status" id="token-validation-status"></div>
            {% if errors and errors.get('token') %}
              <span class="error">{{ errors.get('token') }}</span>
            {% endif %}
          </label>
          <label>
            Max pushes per user per day <span class="required">*</span>
            <input type="number" name="max_pushes_per_user_per_day" min="1" value="1" required>
            <small class="helper">Protects your audience from spam.</small>
            {% if errors and errors.get('max_pushes_per_user_per_day') %}
              <span class="error">{{ errors.get('max_pushes_per_user_per_day') }}</span>
            {% endif %}
          </label>
          <input type="hidden" name="token_validated" id="token-validated" value="false">
          <div class="form-actions">
            <button class="button secondary" type="button" id="validate-bot-token">Validate token</button>
            <button class="button" type="submit" id="save-bot-button" disabled>Save &amp; continue</button>
          </div>
        </form>
      {% endif %}
    </section>
  </div>

  <div class="wizard-step" data-step="2">
    <section class="card dark">
      <h2>Step 2 — Upload Audience CSV</h2>
      <p class="muted">CSV format: <code>tg_id, locale</code></p>
      <form method="post" action="/bot-owner/bots/{{ bot.id }}/upload" enctype="multipart/form-data">
        <input type="file" name="file" accept=".csv" required>
        <small class="helper">Supports comma, semicolon, or tab-separated files.</small>
        <div class="form-actions">
          <button class="button" type="submit">Upload &amp; continue</button>
        </div>
      </form>
      {% if request.query_params.get('uploaded') %}
        <div class="alert success">
          Uploaded {{ request.query_params.get('total') }} rows. Accepted {{ request.query_params.get('accepted') }}, Rejected {{ request.query_params.get('rejected') }}.
          {% if request.query_params.get('error_report_id') %}
            <a class="link" href="/bot-owner/bots/{{ bot.id }}/error-report?report_id={{ request.query_params.get('error_report_id') }}">Download error report</a>
          {% endif %}
        </div>
      {% endif %}
      {% if locale_counts %}
        <h3>Users by locale</h3>
        <div class="locale-grid">
          {% for locale, total in locale_counts %}
            <div class="locale-pill">{{ locale }} — {{ total }}</div>
          {% endfor %}
        </div>
      {% endif %}
    </section>
  </div>

  <div class="wizard-step" data-step="3">
    <section class="card dark">
      <h2>Step 3 — Verify Audience</h2>
      <p class="muted">Verification runs in the background and uses silent pings.</p>
      <form method="post" action="/bot-owner/bots/{{ bot.id }}/verify/start">
        <button class="button" type="submit">Start verification</button>
      </form>
      {% if verification %}
        <div class="stats-grid" data-verification="{{ bot.id }}">
          <div>
            <div class="stat-label">Verified / Total</div>
            <div class="stat-value" data-stat="verified">{{ verification.verified_users }}</div>
            <div class="muted">of <span data-stat="total">{{ verification.total_users }}</span></div>
          </div>
          <div>
            <div class="stat-label">OK</div>
            <div class="stat-value" data-stat="ok">{{ verification.ok_count }}</div>
          </div>
          <div>
            <div class="stat-label">Blocked</div>
            <div class="stat-value" data-stat="blocked">{{ verification.blocked_count }}</div>
          </div>
          <div>
            <div class="stat-label">Not Started</div>
            <div class="stat-value" data-stat="not_started">{{ verification.not_started_count }}</div>
          </div>
          <div>
            <div class="stat-label">Other Errors</div>
            <div class="stat-value" data-stat="other_error">{{ verification.other_error_count }}</div>
          </div>
          <div>
            <div class="stat-label">ETA</div>
            <div class="stat-value" data-stat="eta">{{ (verification.eta_seconds / 60) | round(1) }} min</div>
          </div>
        </div>
        <div class="progress-bar">
          <div class="progress" data-progress="{{ bot.id }}" style="width: 0%"></div>
        </div>
        <div class="locale-status" id="locale-status-list"></div>
      {% endif %}
    </section>
  </div>

  <div class="wizard-step" data-step="4">
    <section class="card dark">
      <h2>Step 4 — Pricing</h2>
      <form method="post" action="/bot-owner/bots/{{ bot.id }}/pricing">
        <table>
          <thead>
            <tr>
              <th>Locale</th>
              <th>Min price per 1000</th>
            </tr>
          </thead>
          <tbody>
            {% for locale in pricing_locales %}
              {% set existing = (pricing_rows | selectattr('locale', 'equalto', locale.locale) | list) %}
              {% set row = existing[0] if existing else None %}
              <tr>
                <td>
                  {{ locale.locale }}
                  <input type="hidden" name="locale_{{ locale.locale }}" value="1">
                </td>
                <td>
                  <input type="number" min="1" name="cpm_{{ locale.locale }}" value="{{ row.cpm_cents if row else 10 }}">
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        <div class="form-actions">
          <button class="button" type="submit">Finish</button>
        </div>
      </form>
    </section>
  </div>

  <div class="wizard-step" data-step="5">
    <section class="card dark">
      <h2>Step 5 — Test Push</h2>
      <p class="muted">Send a test push to one or more Telegram IDs (comma or newline separated).</p>
      <form method="post" action="/bot-owner/bots/{{ bot.id }}/test-push" class="form-grid">
        <label>
          Telegram IDs
          <textarea name="tg_ids" rows="3" placeholder="123456789\n987654321" required></textarea>
          <small class="helper">Test messages can be delivered only to users who have already started the bot.</small>
        </label>
        <label>
          Message (HTML)
          <textarea name="message" rows="4" placeholder="Hello! <b>Test</b>" required></textarea>
          <small class="helper">Allowed tags: &lt;b&gt; &lt;i&gt; &lt;u&gt; &lt;s&gt; &lt;a&gt; &lt;code&gt; &lt;pre&gt;.</small>
        </label>
        <div class="form-actions">
          <button class="button" type="submit">Send test push</button>
        </div>
      </form>
      {% if test_results %}
        <div class="card dark">
          <h3>Results</h3>
          <ul class="results-list">
            {% for result in test_results %}
              <li class="result {{ result.status }}">
                <strong>{{ result.tg_id }}</strong> — {{ result.detail }}
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </section>
  </div>
</div>
{% endblock %}
